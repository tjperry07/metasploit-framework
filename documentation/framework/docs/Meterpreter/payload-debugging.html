<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Metasploit Versions 4,5" />
  <title>Payload Debugging</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
  </style>
  <link rel="stylesheet" href="../styles.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,700;1,300;1,400&display=swap" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <nav class="right">
    <ul>
      <li style="display: inline;"> <a href="https://github.com/rapid7/metasploit-framework/tree/master/documentation/modules">Module Docs</a></li>
      <li style="display: inline;"><a href="https://rapid7.github.io/metasploit-framework/api/">API</a></li>
    </ul>
  </nav>
</head>
<body>

<div id="main-outer-box">

<div id="my-header">
  <a href="../index.html">Metasploit Framework</a>
</div>

<div id="trunk-box">

<div id="nav-box">
<p>Contents:</p>
<ul>
<li><a href=".././markdown-cheat-sheet.html">Markdown Cheat Sheet</a></li>
<li>Getting-Started/
<ul>
<li><a href=".././Getting-Started/setting-up-metasploit-dev-enviroment.html">Setting up a Metasploit Developer Environment</a></li>
</ul></li>
<li>Utilities/
<ul>
<li><a href=".././Utilities/complier-windows-c.html">How to use Metasploit Framework Compiler Windows to compile C code</a></li>
<li><a href=".././Utilities/oracle-support-kali-linux.html">Oracle Support working with Kali Linux</a></li>
</ul></li>
<li>Modules/
<ul>
<li><a href=".././Modules/modules.html">Some stuff about modules</a></li>
<li>How-To/
<ul>
<li><a href=".././Modules/How-To/login-scanner.html">Create a Login Scanner Module</a></li>
<li><a href=".././Modules/How-To/http-login-scanner.html">How to write a HTTP LoginScanner Module</a></li>
</ul></li>
<li><a href=".././Modules/get-started-writing-post-module.html">Get started with writing a post module</a></li>
<li><a href=".././Modules/get-started-writing-auxillary-module.html">Get started with writing an auxiliary module</a></li>
<li><a href=".././Modules/module-reference-identifiers.html">Module Reference Identifiers</a></li>
</ul></li>
<li>Exploits/
<ul>
<li><a href=".././Exploits/writing-exploits.html">Get Started Writing an Exploit</a></li>
<li><a href=".././Exploits/exploit-ranking.html">Exploit Ranking</a></li>
</ul></li>
<li>Meterpreter/
<ul>
<li><a href="about-meterpreter.html">About Meterpreter</a></li>
<li><a href="meterpreter-configuration.html">Meterpreter Configuration</a></li>
<li><a href="how-payloads-work.html">How Payloads Work</a></li>
<li><a href="transport-control.html">Transport Control</a></li>
<li><a href="debugging-dead-sessions.html">Debugging Dead Meterpreter Sessions</a></li>
<li><strong>Payload Debugging</strong></li>
</ul></li>
<li>Evasion-and-Obfuscation/
<ul>
<li><a href=".././Evasion-and-Obfuscation/obfuscation-crandomizer.html">Metasploit Framework</a></li>
</ul></li>
</ul>

</div>

<div id="article-box">

<div id="header-nav-bar">
<div><a href="debugging-dead-sessions.html">←prev</a></div><div class="nav-bar-push"><a href=".././Evasion-and-Obfuscation/obfuscation-crandomizer.html">next→</a></div>
</div>

<div id="article-content">
<header id="title-block-header">
<h1 class="title">Payload Debugging</h1>
<p class="author">Metasploit Versions 4,5</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#terminology">Terminology</a></li>
<li><a href="#general-notes">General Notes</a></li>
<li><a href="#framework-side">Framework Side</a>
<ul>
<li><a href="#general-meterpreter-api-architecture">General Meterpreter API Architecture</a></li>
</ul></li>
<li><a href="#target-side-windowsmeterpreter">Target Side (<code>windows/meterpreter</code>)</a></li>
<li><a href="#target-side-pythonmeterpreter">Target Side (<code>python/meterpreter</code>)</a></li>
<li><a href="#target-side-mettle-meterpreter">Target Side (Mettle Meterpreter)</a></li>
</ul>
</nav>
<p>When debugging Metasploit Framework payloads, it’s important to identify on which side the issue is that needs to be examined. It’s possible and common to debug both sides (the framework side and the target side )but the process to configure each is unique.</p>
<h2 id="terminology">Terminology</h2>
<p><strong>Framework Side</strong> – What is referred to as the “framework side” within this article is the host on which the Metasploit Framework is running. The code on this side is generally Ruby and debugging usually involves inspecting the various modules and libraries provided by Metasploit.</p>
<p><strong>Target Side</strong> – What is referred to as the “target side” within this article is the host on which the payload is being executed. In the context of an exploit module, this would be the <code>RHOST</code>. Debugging the target side is very dependent on which payload is being inspected. For example, the Windows native Meterpreter requires a custom build process and more complex errors may require a native debugger to be used such as WinDBG.</p>
<h2 id="general-notes">General Notes</h2>
<p>If a payload fails to execute, first try to identify if it is an issue specific to the payload, or the way in which it is executed. If (for example) both Meterpreter and Shell payloads are failing, the issue could be with the exploit module that delivered them.</p>
<p>If a Meterpreter session is not being fully established, it’s possibly due to an issue with the stager component rather than Meterpreter itself. To test this, try to switch to a different staged payload such as a shell or VNC configuration.</p>
<h2 id="framework-side">Framework Side</h2>
<h3 id="general-meterpreter-api-architecture">General Meterpreter API Architecture</h3>
<p>When a post module invokes a method that leverages the running Meterpreter instance, it uses a method defined in Ruby within the <code>lib/rex/post/meterpreter/extensions</code> directory. This function typically processes the arguments and turns them into one or more TLVs to be dispatched by the core Meterpreter code. These TLVs are then placed within a transport-specific protocol and transmitted to Meterpreter.</p>
<h2 id="target-side-windowsmeterpreter">Target Side (<code>windows/meterpreter</code>)</h2>
<p>Debugging the Windows native Meterpreter requires building from source with a specific set of options. The <a href="https://github.com/rapid7/metasploit-payloads/tree/master/c/meterpreter">README.md</a> file outlines these steps but to summarize, it involves using Visual Studio, opening the project and selecting the debug configuration.</p>
<p>With this configuration in place, various information will be logged by the Meterpreter process using the Windows API function <a href="https://docs.microsoft.com/en-us/windows/win32/api/debugapi/nf-debugapi-outputdebugstringa"><code>OutputDebugStringA</code></a>. To receive this output, it’s necessary to have a debugger such as WinDBG attached to the process in which the Meterpreter is running (use the <code>getpid</code> command to view the current process ID).</p>
<h2 id="target-side-pythonmeterpreter">Target Side (<code>python/meterpreter</code>)</h2>
<p>The Python Meterpreter can generate debugging output by setting the following datastore options:</p>
<table>
<thead>
<tr class="header">
<th>Datastore Option</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>PythonMeterpreterDebug</code></td>
<td><code>true</code></td>
<td>Enable generating debug output</td>
</tr>
<tr class="even">
<td><code>MeterpreterTryToFork</code></td>
<td><code>false</code></td>
<td>Keep the process in the foreground</td>
</tr>
</tbody>
</table>
<p>With these two options set, the payload can be executed from the command line and diagnostic information will be displayed. To interact with and debug the payload, use Python’s included <code>pdb</code> module. Write the stager output to a file, then start it with the debugger attached using the command <code>python -m pdb meterpreter.py</code>. For a more fully-featured debugging CLI, use the third-party IPython variant <code>ipdb</code>.</p>
<h2 id="target-side-mettle-meterpreter">Target Side (Mettle Meterpreter)</h2>
<p>The Mettle Meterpreter can generate debugging output by setting the following datastore options:</p>
<table>
<thead>
<tr class="header">
<th>Datastore Option</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>MeterpreterDebugLevel</code></td>
<td><code>3</code></td>
<td>Increase the level of output</td>
</tr>
<tr class="even">
<td><code>PrependFork</code></td>
<td><code>false</code></td>
<td>Keep the process in the foreground</td>
</tr>
</tbody>
</table>
<p>With these two options set, the payload can be executed from the command line and diagnostic information will be displayed. To interactively debug the payload (inspect the state, memory, set breakpoints etc.) use a native debugger for the specific platform on which it is running (e.g. use <code>gdb</code> when debugging on the Linux platform).</p>

</div> <!-- article-content -->

<div id="footer-nav-bar">
<div><a href="debugging-dead-sessions.html">←prev</a></div><div class="nav-bar-push"><a href=".././Evasion-and-Obfuscation/obfuscation-crandomizer.html">next→</a></div>
</div>

</div> <!-- article-box -->

</div> <!-- trunk-box -->

<div id="my-footer">
<p>Copyright <a href="https://metasploit.com/">Metasploit</a>, 2020</p>
<p><a href="https://join.slack.com/t/metasploit/shared_invite/enQtOTMxMjg5ODY3NDYxLTYyZTVlNDM1ZTI3ZGQ0YTQ0NmI1YjgxMGEwYzFhOWNiZWQ4NDNmNTE1MWNiYzJhMzgwMGY0ZWY2NTY0MjA2M2I">Slack team - metasploit.slack.com</a></p>
<p><a href="https://twitter.com/metasploit">#twitter handle - @metasploit</a></p>
<p><a href="mailto:msfdev@metasploit.com">development questions - msfdev [ @ ] metasploit.com</a></p><br/>
<a href="payload-debugging.md">Pandoc-Markdown source for this page</a><br/>
(Docs processed by
<a href="http://www.unexpected-vortices.com/sw/rippledoc/index.html">Rippledoc</a>.)
</div> <!-- my-footer -->

</div> <!-- main-outer-box -->

</body>
</html>
